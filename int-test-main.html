<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Intregation Testing @ ABN AMRO</title>

		<link rel="stylesheet" href="../../reveal.js/dist/reset.css">
		<link rel="stylesheet" href="../../reveal.js/dist/reveal.css">
		<link rel="stylesheet" href="../../reveal.js/dist/theme/black.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="../../reveal.js/plugin/highlight/monokai.css" id="highlight-theme">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
                <!-- Slides are separated by newline + three dashes + newline, vertical slides identical but two dashes -->
                <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n--\n$">
					<textarea data-template>
					## Integration testing
					<img src="images/testcontainers-logo.svg" width="80%"/>
					<img src="images/wireMockLogo.png" width="60%"/>

					--
					
					## Who are we

					Joost van Gils & Nishanth Athikayala
					
					Java Developers
					
					Payments Gladiators
					
					---
					
					## What is integration testing?
					
					--

					## Types of testing
					* Unit testing
					* Integration testing
					* End-to-end testing
						
					Note:
					* Unit: test a single piece of code in isolation
					* End-to-end: test the complete application from the start

					--

					## Integration Testing

					...the process of testing the interface between two software units. Its focus is on determining the correctness of the interface. Integration testing aims to expose faults in the interaction between integrated units. 
					
					Note:
					Software units: Think database or other API

					--

					## Some characteristics

					* All modules of the software are tested combined
					* No need to know internal design of the software
					* Sits in between unit testing and end-to-end testing
					* Costlier than unit testing (creating/performing)
					* Ensures the proper working of code with the external dependencies
					* Typically: no mocks or stubs

					Note:
					* black-box
					* Many "levels" of production resemblance: in-memory vs real production database

					--

					## Why integration testing?

					* To test the interaction/connectivity to external services
					* Where a unit test is not possible/make no sense
					* Test load/performance and functional behavior
					* More convincing at demonstrating correctness

					Note:
					* Implementation can change, the behavior should not (black box). Useful in rebuild.
					
					---

					## Test Containers
					https://testcontainers.com/

					--

					*Testcontainers is an open source framework for providing throwaway, lightweight instances of databases, message brokers, web browsers, or just about anything that can run in a Docker container.*

					--

					*It is a library that provides easy and lightweight APIs for bootstrapping local development and test dependencies with real services wrapped in Docker containers. You can write tests that depend on the same services you use in production without mocks or in-memory services.*

					--

					## Architecture

					![architecture](images/cn-arch-tc.png)

					--

					## Test flow

					![flow](images/test-workflow.png)

					--
					
					## Preconfigured [modules](https://testcontainers.com/modules/)		
					```java
					var mssqlserver = new MSSQLServerContainer()
						.acceptLicense();
					mssqlserver.start();


					```

					```java
					var wiremockServer = new WireMockContainer("2.35.0")
						.withMapping("hello", 
									 WireMockContainerJunit5Test.class, 
									 "hello-world.json");
					wiremockServer.start();                


					```

					Note:
					* You can use any Docker container using GenericContainer
					
					--

					## Generic Container API

					```java
					var container = new GenericContainer("postgres:15")
						.withExposedPorts(5432)
						.waitingFor(new LogMessageWaitStrategy()
							.withRegEx(".*ready to accept connections.*\\s")
							.withTimes(2)
							.withStartupTimeout(Duration.of(60, SECONDS)));
					container.start();
					var username = "test";
					var password = "test";
					var jdbcUrl = "jdbc:postgresql://" + container.getHost() + 
						":" + container.getMappedPort(5432) + "/test";
					//perform db operations
					container.stop();
					```

					--

					# maven setup

					```xml
					<dependency>
						<groupId>org.testcontainers</groupId>
						<artifactId>testcontainers</artifactId>
					</dependency>
					<dependency>
						<groupId>org.testcontainers</groupId>
						<artifactId>junit-jupiter</artifactId>
					</dependency>
					<dependency>
						<groupId>org.testcontainers</groupId>
						<artifactId>mssqlserver</artifactId>
					</dependency>
					```

					--
					
					## Local testing: SQL Server

					```yml
					spring:
						datasource:
							url: jdbc:tc:sqlserver:2022-latest:///test-db
					```

					--

					## Optional: Flyway

					Prepare the database for running tests

					```yml
					spring:
						flyway:
							locations: classpath:db/migration

					--
					
					## Run your app locally

					```yml
					spring:
					  datasource:
						url: jdbc:sqlserver://localhost:1433;
									databaseName=localdb;encrypt=false
						username: sa
						password: secret
						driver-class-name: com.microsoft.sqlserver.jdbc
									.SQLServerDriver
					```	

					--

					## Azure DevOps CI

					```yml
					spring:
						datasource:
						url: jdbc:sqlserver://sqlserver-host:1433;encrypt=false
						username: sa
						password: secret
						driver-class-name: com.microsoft.sqlserver.jdbc
									.SQLServerDriver

					```

					Note: 
					you cannot run testcontainers on Azure at ABN

					--

					## Docker Compose
					```yml
					version: '3.9'
					services:
						sqlserver:
							image: p-nexus-3.development.nl.eu.abnamro.com:18445
								/microsoft/mssql-server-linux:2017-latest
							hostname: sqlserver-host
							environment:
							- ACCEPT_EULA=Y
							- SA_PASSWORD=secret
							ports:
							- "1433:1433"
					```

					--

					## Pipeline

					```yml
					- template: flows/java-maven.yml@templates
						parameters:
							docker_compose_file: sqlserver-docker-compose.yml
							run_unittests_with_containers: true
							optional_maven_parameters: -Pci-integration
							...
					  ```

					---

					## Wiremock
					todo

					---

					# Demo!

					---

					## Thank you!
					joost.van.gils@nl.abnamro.com
					nishanth.athikayala@nl.abnamro.com

					--

					## Links
					* https://testcontainers.com/
					* https://wiremock.org/
					* https://dev.azure.com/cbsp-abnamro/GRD0001005/_git/eman-emandates-issuer

					</textarea>
				</section>
			</div>
		</div>

		<script src="../../reveal.js/dist/reveal.js"></script>
		<script src="../../reveal.js/plugin/notes/notes.js"></script>
		<script src="../../reveal.js/plugin/markdown/markdown.js"></script>
		<script src="../../reveal.js/plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				navigationMode: 'linear',
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
